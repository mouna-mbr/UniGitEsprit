<div class="app-container" *ngIf="isUsersLoaded">
  <div class="content">
    <div class="content-header">
      <div class="page-info">
        <div class="breadcrumb">
          <a href="/classes" class="breadcrumb-link">
            <i class="fas fa-graduation-cap"></i>
            Classes
          </a>
          <i class="fas fa-chevron-right breadcrumb-separator"></i>
          <span class="breadcrumb-current">Ajouter une Classe</span>
        </div>
        <h1>Ajouter une Nouvelle Classe</h1>
        <p class="subtitle">Créez une nouvelle classe et ajoutez des étudiants</p>
      </div>
    </div>

    <div class="form-container">
      <form [formGroup]="classeForm" (ngSubmit)="onSubmit()" class="add-class-form">
        <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>

        <!-- Section Informations de la Classe -->
        <div class="form-section">
          <div class="section-header">
            <div class="section-icon">
              <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="section-info">
              <h3>Informations de la Classe</h3>
              <p>Détails généraux de la classe</p>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="nom" class="form-label">
                <i class="fas fa-tag"></i>
                Nom de la Classe *
              </label>
              <input
                type="text"
                id="nom"
                formControlName="nom"
                class="form-input"
                placeholder="Ex: 4 AI 09"
                [class.error]="classeForm.get('nom')?.invalid && classeForm.get('nom')?.touched"
              >
              <div class="error-message" *ngIf="classeForm.get('nom')?.invalid && classeForm.get('nom')?.touched">
                Le nom de la classe est requis
              </div>
            </div>

            <div class="form-group">
              <label for="anneeUniversitaire" class="form-label">
                <i class="fas fa-calendar-alt"></i>
                Année Universitaire *
              </label>
              <select
                id="anneeUniversitaire"
                formControlName="anneeUniversitaire"
                class="form-select"
                [class.error]="classeForm.get('anneeUniversitaire')?.invalid && classeForm.get('anneeUniversitaire')?.touched"
              >
                <option value="">Sélectionnez l'année universitaire</option>
                <option value="2023/2024">2023/2024</option>
                <option value="2024/2025">2024/2025</option>
                <option value="2025/2026">2025/2026</option>
              </select>
              <div class="error-message" *ngIf="classeForm.get('anneeUniversitaire')?.invalid && classeForm.get('anneeUniversitaire')?.touched">
                L'année universitaire est requise
              </div>
            </div>

            <div class="form-group">
              <label for="level" class="form-label">
                <i class="fas fa-layer-group"></i>
                Niveau *
              </label>
              <select
                id="level"
                formControlName="level"
                class="form-select"
                [class.error]="classeForm.get('level')?.invalid && classeForm.get('level')?.touched"
              >
                <option value="">Sélectionnez le niveau</option>
                <option value="L1">L1</option>
                <option value="L2">L2</option>
                <option value="L3A">L3A</option>
                <option value="L3B">L3B</option>
                <option value="L4">L4</option>
                <option value="L5">L5</option>
                <option value="M1">M1</option>
                <option value="M2">M2</option>
              </select>
              <div class="error-message" *ngIf="classeForm.get('level')?.invalid && classeForm.get('level')?.touched">
                Le niveau est requis
              </div>
            </div>

            <div class="form-group">
              <label for="optionFormation" class="form-label">
                <i class="fas fa-book"></i>
                Option de Formation *
              </label>
              <input
                type="text"
                id="optionFormation"
                formControlName="optionFormation"
                class="form-input"
                placeholder="Entrez l'option de formation (ex: Informatique)"
                [class.error]="classeForm.get('optionFormation')?.invalid && classeForm.get('optionFormation')?.touched"
              >
              <div class="error-message" *ngIf="classeForm.get('optionFormation')?.invalid && classeForm.get('optionFormation')?.touched">
                L'option de formation est requise
              </div>
            </div>
          </div>
        </div>

        <!-- Section Étudiants -->
        <div class="form-section">
          <div class="section-header">
            <div class="section-icon">
              <i class="fas fa-user-graduate"></i>
            </div>
            <div class="section-info">
              <h3>Étudiants de la Classe</h3>
              <p>Ajoutez des étudiants à cette classe</p>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" (click)="addStudent()">
              <i class="fas fa-plus"></i>
              Ajouter un Étudiant
            </button>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-user-friends"></i>
              Étudiants
            </label>
            <div class="members-container">
              <div class="members-list">
                <div *ngFor="let studentId of classeForm.get('etudiantIds')?.value; let i = index" class="member-tag" [class.newly-added]="isNewlyAdded(studentId)">
                  <span>{{ getUserName(studentId) }} (ID: {{ studentId }})</span>
                  <button type="button" class="remove-member" (click)="removeStudent(i)">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div *ngIf="classeForm.get('etudiantIds')?.value.length === 0" class="empty-members">
                  <p>Aucun étudiant ajouté</p>
                </div>
              </div>
              <div class="add-member-section">
                <select
                  [(ngModel)]="newStudentId"
                  [ngModelOptions]="{standalone: true}"
                  class="form-select member-input"
                >
                  <option value="">Sélectionnez un étudiant</option>
                  <option *ngFor="let user of users" [value]="user.id" [disabled]="!user.roles.includes(Role.STUDENT)">{{ user.firstName }} {{ user.lastName }}</option>
                </select>
                <button type="button" class="btn-add-member" (click)="addStudent()">
                  <i class="fas fa-plus"></i>
                  Ajouter l'Étudiant
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Section Enseignants -->
        <div class="form-section">
          <div class="section-header">
            <div class="section-icon">
              <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <div class="section-info">
              <h3>Enseignants de la Classe</h3>
              <p>Assignez des enseignants à cette classe</p>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" (click)="addTeacher()">
              <i class="fas fa-plus"></i>
              Ajouter un Enseignant
            </button>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-chalkboard-teacher"></i>
              Enseignants
            </label>
            <div class="members-container">
              <div class="members-list">
                <div *ngFor="let teacherId of classeForm.get('enseignantIds')?.value; let i = index" class="member-tag" [class.newly-added]="isNewlyAdded(teacherId)">
                  <span>{{ getUserName(teacherId) }} (ID: {{ teacherId }})</span>
                  <button type="button" class="remove-member" (click)="removeTeacher(i)">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div *ngIf="classeForm.get('enseignantIds')?.value.length === 0" class="empty-members">
                  <p>Aucun enseignant ajouté</p>
                </div>
              </div>
              <div class="add-member-section">
                <select
                  [(ngModel)]="newTeacherId"
                  [ngModelOptions]="{standalone: true}"
                  class="form-select member-input"
                >
                  <option value="">Sélectionnez un enseignant</option>
                  <option *ngFor="let user of users" [value]="user.id" [disabled]="!user.roles.includes(Role.PROFESSOR)">{{ user.firstName }} {{ user.lastName }}</option>
                </select>
                <button type="button" class="btn-add-member" (click)="addTeacher()">
                  <i class="fas fa-plus"></i>
                  Ajouter l'Enseignant
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions du Formulaire -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="goBack()">
            <i class="fas fa-arrow-left"></i>
            Retour
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="classeForm.invalid || classeForm.get('etudiantIds')?.value.length === 0">
            <i class="fas fa-plus"></i>
            Créer la Classe
          </button>
        </div>
      </form>
    </div>
  </div>
</div>