<div class="p-6">

  <!-- Header + bouton principal -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">Gestion des utilisateurs</h2>
    <button class="btn btn-primary flex items-center gap-2" (click)="toggleForm()">
      <i class="fas fa-plus"></i> {{ buttonText }}
    </button>
  </div>

  <!-- ==================== LISTE ==================== -->
  <div *ngIf="!showForm">
    <table class="min-w-full border">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-4 py-2 text-left">Nom complet</th>
          <th class="px-4 py-2 text-left">Email</th>
          <th class="px-4 py-2 text-left">Rôles</th>
          <th class="px-4 py-2 text-left">Créé le</th>
          <th class="px-4 py-2 text-left">Classe</th>
          <th class="px-4 py-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of users" class="border-b">
          <td class="px-4 py-2">{{ u.lastName }} {{ u.firstName }}</td>
          <td class="px-4 py-2">{{ u.email }}</td>
          <td class="px-4 py-2">
            <span *ngFor="let r of u.roles; let last = last">
              {{ r }}{{ last ? '' : ', ' }}
            </span>
          </td>
          <td class="px-4 py-2">{{ u.createdAt | date:'short' }}</td>
          <td class="px-4 py-2">{{ u.classe || '-' }}</td>
          <td class="px-4 py-2">
            <button class="btn btn-sm btn-warning mr-2" (click)="openEdit(u)">Edit</button>
            <button class="btn btn-sm btn-danger" (click)="delete(u)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ==================== FORMULAIRE / CSV ==================== -->
  <div *ngIf="showForm" class="mt-6">

    <!-- Toggle CSV / Form -->
    <div class="mb-4">
      <button class="btn btn-outline" (click)="toggleCsv()">
        {{ isCsvMode ? 'Passer au formulaire' : 'Passer au CSV' }}
      </button>
    </div>

    <!-- ------------------- FORMULAIRE UNIQUE ------------------- -->
    <div *ngIf="!isCsvMode">
      <form [formGroup]="userForm" (ngSubmit)="selectedUser ? saveEdit() : onSubmit()" class="space-y-4">

        <!-- Nom / Prénom -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block font-medium">Nom <span class="text-danger">*</span></label>
            <input formControlName="lastName" class="input w-full" placeholder="Nom">
            <div *ngIf="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched" class="text-danger text-sm">
              Nom requis.
            </div>
          </div>
          <div>
            <label class="block font-medium">Prénom <span class="text-danger">*</span></label>
            <input formControlName="firstName" class="input w-full" placeholder="Prénom">
            <div *ngIf="userForm.get('firstName')?.invalid && userForm.get('firstName')?.touched" class="text-danger text-sm">
              Prénom requis.
            </div>
          </div>
        </div>

        <!-- Email -->
        <div>
          <label class="block font-medium">Email <span class="text-danger">*</span></label>
          <input type="email" formControlName="email" class="input w-full" placeholder="email@exemple.com">
          <div *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched" class="text-danger text-sm">
            Email invalide.
          </div>
        </div>

        <!-- Rôles -->
        <div>
          <label class="block font-medium">Rôles <span class="text-danger">*</span></label>
          <div class="flex flex-wrap gap-2 mb-2">
            <span *ngFor="let r of userRoles" class="chip">
              {{ r }}
              <button type="button" (click)="removeRole(r)" class="ml-1 text-xs">×</button>
            </span>
          </div>
          <select (change)="addRole($event)" class="select w-full">
            <option value="">-- Choisir un rôle --</option>
            <option *ngFor="let r of availableRoles" [value]="r" [disabled]="userRoles.includes(r)">
              {{ r }}
            </option>
          </select>
          <div *ngIf="userForm.get('roles')?.invalid && userForm.get('roles')?.touched" class="text-danger text-sm">
            Au moins un rôle requis.
          </div>
        </div>

        <!-- Classe (si STUDENT) -->
        <div *ngIf="userRoles.includes(Role.STUDENT)">
          <label class="block font-medium">Classe <span class="text-danger">*</span></label>
          <select formControlName="classe" class="select w-full">
            <option value="">-- Sélectionner --</option>
            <option *ngFor="let c of classOptions" [value]="c.nom">{{ c.nom }}</option>
          </select>
          <div *ngIf="userForm.get('classe')?.invalid && userForm.get('classe')?.touched" class="text-danger text-sm">
            Classe requise pour étudiant.
          </div>
        </div>

        <!-- Identifiant -->
        <div>
          <label class="block font-medium">Identifiant <span class="text-danger">*</span></label>
          <input formControlName="identifiant" class="input w-full" placeholder="123ABC4567">
          <div *ngIf="userForm.get('identifiant')?.invalid && userForm.get('identifiant')?.touched" class="text-danger text-sm">
            Format: 123ABC4567
          </div>
        </div>

        <!-- Mot de passe (création uniquement) -->
        <div *ngIf="!selectedUser">
          <label class="block font-medium">Mot de passe <span class="text-danger">*</span></label>
          <div class="relative">
            <input [type]="showPassword ? 'text' : 'password'" formControlName="password"
                   class="input w-full pr-10" placeholder="••••••">
            <button type="button" class="absolute right-2 top-2" (click)="showPassword = !showPassword">
              <i class="fas" [ngClass]="showPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
            </button>
          </div>
          <div *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched" class="text-danger text-sm">
            Minimum 6 caractères.
          </div>
        </div>

        <!-- Git -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block font-medium">Git Username</label>
            <input formControlName="gitUsername" class="input w-full">
          </div>
          <div>
            <label class="block font-medium">Git Token</label>
            <input formControlName="gitAccessToken" class="input w-full">
          </div>
        </div>

        <!-- Boutons -->
        <div class="flex gap-2">
          <button type="button" class="btn btn-secondary" (click)="toggleForm()">Annuler</button>
          <button type="submit" class="btn btn-primary" [disabled]="isSubmitting || userForm.invalid">
            {{ isSubmitting ? 'Envoi…' : (selectedUser ? 'Mettre à jour' : 'Créer') }}
          </button>
        </div>
      </form>
    </div>

    <!-- ------------------- CSV ------------------- -->
    <div *ngIf="isCsvMode" class="space-y-4">
      <h3 class="text-xl font-semibold">Import CSV</h3>

      <input type="file" accept=".csv" (change)="onFileSelected($event)" class="input">

      <p class="text-sm text-gray-600">
        Colonnes : <code>firstName,lastName,email,roles,identifiant,password,classe,gitUsername,gitAccessToken</code><br>
        Rôles séparés par <code>;</code> (ex: <code>STUDENT;PROFESSOR</code>)
      </p>

      <!-- Preview -->
      <div *ngIf="csvData.length" class="overflow-x-auto">
        <table class="min-w-full border text-xs">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-1">Prénom</th>
              <th class="px-2 py-1">Nom</th>
              <th class="px-2 py-1">Email</th>
              <th class="px-2 py-1">Rôles</th>
              <th class="px-2 py-1">Identifiant</th>
              <th class="px-2 py-1">Classe</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of csvData">
              <td class="px-2 py-1">{{ row.firstName }}</td>
              <td class="px-2 py-1">{{ row.lastName }}</td>
              <td class="px-2 py-1">{{ row.email }}</td>
              <td class="px-2 py-1">{{ row.roles?.join(', ') }}</td>
              <td class="px-2 py-1">{{ row.identifiant }}</td>
              <td class="px-2 py-1">{{ row.classe }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <button class="btn btn-primary" (click)="uploadCsv()" [disabled]="!selectedFile || isSubmitting">
        {{ isSubmitting ? 'Import…' : 'Importer' }}
      </button>
    </div>
  </div>
</div>