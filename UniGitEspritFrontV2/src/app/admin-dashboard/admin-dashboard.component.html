<div class="dashboard-container">


  <div class="dashboard admin-dashboard" *ngIf="currentUser?.roles?.includes('ADMIN')">
    <h2>Tableau de Bord Administrateur</h2>
    
    
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="kpi-content">
          <h3>{{totalUsers}}</h3>
          <p>Utilisateurs Totaux</p>
        </div>
      </div>
      
      <div class="kpi-card">
        <div class="kpi-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="kpi-content">
          <h3>{{totalDemandeBdp}}</h3>
          <p>Demandes BDP</p>
        </div>
      </div>
      
      <div class="kpi-card">
        <div class="kpi-icon">
          <i class="fas fa-handshake"></i>
        </div>
        <div class="kpi-content">
          <h3>{{totalDemandeParrainage}}</h3>
          <p>Demandes Parrainage</p>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon">
          <i class="fas fa-code-branch"></i>
        </div>
        <div class="kpi-content">
          <h3>{{totalRepositories}}</h3>
          <p>Dépôts Git</p>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card large">
        <div class="chart-header">
          <h3>Parrainage par Sujet</h3>
          <button class="export-btn" (click)="exportToCSV(parrainageBySujetChart, 'parrainage_sujet')">
            <i class="fas fa-download"></i>
            Export CSV
          </button>
        </div>
        <div class="chart-container">
          <canvas *ngIf="parrainageBySujetChart"
                  baseChart
                  [data]="parrainageBySujetChart"
                  [options]="barChartOptions"
                  type="bar">
          </canvas>
        </div>
      </div>
      <!-- <div class="chart-card large"> -->
        <!-- <div class="chart-header">
          <h3>BDP par sujet</h3>
          <button class="export-btn" (click)="exportToCSV(bdpBySujetChart, 'bdp_sujet')">
            <i class="fas fa-download"></i>
            Export CSV
          </button>
        </div>
        <div class="chart-container">
          <canvas *ngIf="bdpBySujetChart"
                  baseChart
                  [data]="bdpBySujetChart"
                  [options]="barChartOptions"
                  type="bar">
          </canvas>
        </div> -->
      <!-- </div> -->

      <div class="chart-card">
        <div class="chart-header">
          <h3>BDP par Statut</h3>
          <button class="export-btn" (click)="exportToCSV(bdpByStatusChart, 'bdp_statut')">
            <i class="fas fa-download"></i>
            Export CSV
          </button>
        </div>
        <div class="chart-container">
          <canvas *ngIf="bdpByStatusChart"
                  baseChart
                  [data]="bdpByStatusChart"
                  [options]="doughnutChartOptions"
                  type="doughnut">
          </canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h3>Parrainage par Statut</h3>
          <button class="export-btn" (click)="exportToCSV(parrainageByStatusChart, 'parrainage_statut')">
            <i class="fas fa-download"></i>
            Export CSV
          </button>
        </div>
        <div class="chart-container">
          <canvas *ngIf="parrainageByStatusChart"
                  baseChart
                  [data]="parrainageByStatusChart"
                  [options]="doughnutChartOptions"
                  type="doughnut">
          </canvas>
        </div>
      </div>

      <div class="chart-card large">
        <div class="chart-header">
          <h3>Utilisateurs par Rôle</h3>
          <button class="export-btn" (click)="exportToCSV(usersByRoleChart, 'utilisateurs_role')">
            <i class="fas fa-download"></i>
            Export CSV
          </button>
        </div>
        <div class="chart-container">
          <canvas *ngIf="usersByRoleChart"
                  baseChart
                  [data]="usersByRoleChart"
                  [options]="doughnutChartOptions"
                  type="doughnut">
          </canvas>
        </div>
      </div>

    

      <div class="chart-card large">
        <div class="chart-header">
          <h3>Groupes par Sujet</h3>
          <button class="export-btn" (click)="exportToCSV(groupesParSujetChart, 'groupes_sujet')">
            <i class="fas fa-download"></i>
            Export CSV
          </button>
        </div>
        <div class="chart-container">
          <canvas *ngIf="groupesParSujetChart"
                  baseChart
                  [data]="groupesParSujetChart"
                  [options]="barChartOptions"
                  type="bar">
          </canvas>
        </div>
      </div>
      <div >
      <!-- <div class="chart-card large" style="display: flex;">
        <div class="chart-header">
          <h3>Sujets parrainés par Entreprise</h3>
          <button class="export-btn" (click)="exportToCSV(sujetsParraineParEntrepriseChart, 'sujets_parraine_entreprise')">
            <i class="fas fa-download"></i>
            Export CSV
          </button>
        </div>
        <div class="chart-container">
          <canvas *ngIf="sujetsParraineParEntrepriseChart"
                  baseChart
                  [data]="sujetsParraineParEntrepriseChart"
                  [options]="barChartOptions"
                  type="bar">
          </canvas>
        </div> -->
      <!-- </div> -->
      
      </div>
    </div>
  </div>

  <div class="dashboard prof-dashboard" *ngIf="currentUser?.roles?.includes(Role.PROFESSOR)">
    <h2>Tableau de Bord Professeur</h2>

    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-icon">
          <i class="fas fa-code-branch"></i>
        </div>
        <div class="kpi-content">
          <h3>{{stats.totalRepositories || 0}}</h3>
          <p>Dépôts Git</p>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card large">
        <div class="chart-header">
          <h3>Sujets par Groupes</h3>
          <button class="export-btn" (click)="exportToCSV(sujetsByGroupsChart, 'sujets_groupes')">
            <i class="fas fa-download"></i>
            Export CSV
          </button>
        </div>
        <div class="chart-container">
          <canvas baseChart 
                  [data]="sujetsByGroupsChart" 
                  [options]="barChartOptions"
                  type="bar">
          </canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h3>Top 3 Groupes par Note</h3>
          <button class="export-btn" (click)="exportToCSV(topGroupsByNoteChart, 'top_groupes_notes')">
            <i class="fas fa-download"></i>
            Export CSV
          </button>
        </div>
        <div class="chart-container">
          <canvas baseChart 
                  [data]="topGroupsByNoteChart" 
                  [options]="barChartOptions"
                  type="bar">
          </canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h3>Tâches par Statut</h3>
          <button class="export-btn" (click)="exportToCSV(tachesByStatusChart, 'taches_statut')">
            <i class="fas fa-download"></i>
            Export CSV
          </button>
        </div>
        <div class="chart-container">
          <canvas baseChart 
                  [data]="tachesByStatusChart" 
                  [options]="doughnutChartOptions"
                  type="doughnut">
          </canvas>
        </div>
      </div>

      <div class="chart-card large">
        <div class="chart-header">
          <h3>Commits par Groupe</h3>
          <button class="export-btn" (click)="exportToCSV(commitsParGroupeChartData, 'commits_groupes')">
            <i class="fas fa-download"></i>
            Export CSV
          </button>
        </div>
        <div class="chart-container">
          <canvas baseChart 
                  [data]="commitsParGroupeChartData" 
                  [options]="barChartOptions"
                  type="bar">
          </canvas>
        </div>
      </div>

      <div class="chart-card large" *ngIf="commitsParUtilisateurData && Object.keys(commitsParUtilisateurData).length > 0">
        <div class="chart-header">
          <h3>Commits par Utilisateur par Groupe</h3>
        </div>
        <div class="commits-table-container">
          <div *ngFor="let groupe of Object.keys(commitsParUtilisateurData)" class="groupe-section">
            <h4>{{groupe}}</h4>
            <button class="export-btn small" (click)="exportCommitsParUtilisateur(groupe)">
              <i class="fas fa-download"></i>
              Export
            </button>
            <table class="commits-table">
              <thead>
                <tr>
                  <th>Utilisateur</th>
                  <th>Commits</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of commitsParUtilisateurData[groupe]">
                  <td>{{user.utilisateur}}</td>
                  <td>{{user.commits}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!currentUser?.roles?.includes('ADMIN') && !currentUser?.roles?.includes('PROF')" class="no-access">
    <h3>Accès non autorisé</h3>
    <p>Vous n'avez pas les permissions nécessaires pour accéder à ce tableau de bord.</p>
  </div>

</div>