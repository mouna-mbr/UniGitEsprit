<main class="group-detail-main">
  <div class="group-header">
    <div class="group-info">
      <h1 class="group-title">{{ currentGroup.nom || 'Unnamed Group' }}</h1>
      <p class="group-class">{{ currentClass?.nom || 'No Class' }}</p>
    </div>
    <div class="group-actions">
      <button class="btn btn-secondary" (click)="editGroup()">
        <i class="fas fa-edit"></i> Edit Group
      </button>
      <button class="btn btn-secondary" (click)="viewRepository()" [disabled]="!currentGroup.gitRepoUrl">
        <i class="fas fa-folder"></i> View Repository
      </button>
      <button class="btn btn-primary" (click)="showSettings()">
        <i class="fas fa-cog"></i> Settings
      </button>
    </div>
  </div>

  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-spinner"></div>
    <p>Loading...</p>
  </div>

  <div class="content-grid" *ngIf="!isLoading">
    <!-- Project Pipeline -->
    <div class="card pipeline-card" *ngIf="hasPipeline && currentPipeline">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-project-diagram"></i> {{ currentPipeline.nom }}
        </h2>
        <button class="btn-icon" (click)="openPipelineModal()" title="Create a new pipeline">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div class="pipeline-container">
        <div class="pipeline">
          <ng-container *ngFor="let etape of etapesWithStatus; let i = index; let last = last">
            <div
              class="sprint-node"
              [class.completed]="etape.status === 'completed'"
              [class.active]="etape.status === 'active'"
              [class.overdue]="isOverdue(etape.deadline) && etape.status !== 'completed'"
              (click)="viewSprint(etape)"
            >
              <div class="node-circle">
                <i
                  class="fas"
                  [ngClass]="{
                    'fa-check': etape.status === 'completed',
                    'fa-play': etape.status === 'active',
                    'fa-clock': etape.status === 'pending',
                    'fa-flag-checkered': etape.type === 'final',
                    'fa-exclamation-triangle': isOverdue(etape.deadline) && etape.status !== 'completed'
                  }"
                ></i>
              </div>
              <div class="node-label">{{ etape.nom }}</div>
              <div class="node-status">{{ etape.status | titlecase }}</div>
              <div class="node-deadline" *ngIf="etape.deadline">
                <small>{{ formatDate(etape.deadline) }}</small>
              </div>
              <div class="node-days-remaining" *ngIf="etape.status !== 'completed' && etape.deadline">
                <small [class.text-danger]="isOverdueText(etape.deadline)">
                  {{ getDaysRemainingText(etape.deadline) }}
                </small>
              </div>
            </div>
            <div class="pipeline-line" [class.completed]="etape.status === 'completed'" *ngIf="!last"></div>
          </ng-container>
        </div>
      </div>
    </div>

    <div class="card pipeline-card empty-pipeline" *ngIf="!hasPipeline">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-project-diagram"></i> Project Pipeline
        </h2>
        <button class="btn-icon" (click)="openPipelineModal()">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-project-diagram"></i>
        </div>
        <h3 class="empty-title">No Pipeline Created</h3>
        <p class="empty-description">Create your first project pipeline to track stages and milestones</p>
        <button class="btn btn-primary" (click)="openPipelineModal()">
          <i class="fas fa-plus"></i> Create Pipeline
        </button>
      </div>
    </div>

    <div class="card members-card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-users"></i> Team Members
        </h2>
        <button class="btn-icon" (click)="openAddMemberModal()">
          <i class="fas fa-user-plus"></i>
        </button>
      </div>
      <div class="members-table">
        <div class="table-header">
          <div class="table-cell">Member</div>
          <div class="table-cell">Git Role</div>
          <div class="table-cell">Actions</div>
        </div>
        <div
          class="table-row"
          *ngFor="let member of members"
          (mouseenter)="hoverRow(member, $event)"
          (mouseleave)="unhoverRow(member, $event)"
        >
          <div class="table-cell member-info">
            <div class="member-avatar">
              <i class="fas fa-user"></i>
            </div>
            <div class="member-details">
              <span class="member-name">{{ member.nom }}</span>
              <span class="member-email">{{ member.email }}</span>
            </div>
          </div>
          <div class="table-cell">
            <span class="role-badge developer">{{ member.gitRole || 'N/A' }}</span>
          </div>
          <div class="table-cell">
            <button class="btn-action" (click)="editMember(member)">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-action" (click)="removeMember(member)">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card contributors-card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-trophy"></i> Top Contributors
        </h2>
        <button class="btn-icon" (click)="refreshContributions()">
          <i class="fas fa-sync-alt" [class.fa-spin]="isRefreshing"></i>
        </button>
      </div>
      <div class="contributors-podium">
        <ng-container *ngFor="let contributor of contributors; let i = index">
          <div class="contributor" [ngClass]="['place-' + (i + 1)]">
            <div class="contributor-avatar">
              <i class="fas fa-user"></i>
            </div>
            <div class="contributor-name">{{ contributor.name }}</div>
            <div class="contributor-rank">{{ contributor.rank }}</div>
            <div class="contributor-stats">
              <span class="commits">{{ contributor.commits }} commits</span>
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <div class="card repositories-card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-code-branch"></i> Repository
        </h2>
        <button class="btn-icon" (click)="addRepository()">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div class="repositories-list">
        <div class="repo-info">
          <div class="repo-icon">
            <i class="fab fa-github"></i>
          </div>
          <div class="repo-details">
            <span class="repo-name">{{ currentRepositoryName || 'No Repository' }}</span>
            <span class="repo-url">{{ currentRepositoryUrl || 'No URL provided' }}</span>
          </div>
        </div>
        <div class="repo-actions">
          <button class="btn-action" (click)="viewRepository()" [disabled]="!currentRepositoryUrl">
            <i class="fas fa-external-link-alt"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Pipeline Creation Modal -->
<div class="modal-overlay" *ngIf="showPipelineModal" (click)="closePipelineModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="fas fa-project-diagram"></i> Create Project Pipeline
      </h2>
      <button class="modal-close" (click)="closePipelineModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form (ngSubmit)="createPipeline()" #pipelineForm="ngForm">
        <div class="form-group">
          <label for="pipelineName">Pipeline Name *</label>
          <input
            type="text"
            id="pipelineName"
            class="form-control"
            [(ngModel)]="newPipeline.nom"
            name="pipelineName"
            placeholder="Enter pipeline name"
            required
            #pipelineName="ngModel"
          >
          <div *ngIf="pipelineName.invalid && pipelineName.touched" class="text-danger">
            Pipeline name is required.
          </div>
        </div>

        <div class="form-group">
          <label>Stage Configuration</label>
          <div class="etapes-config">
            <div class="etape-item" *ngFor="let etape of newPipeline.etapes; let i = index">
              <div class="etape-header">
                <h4>Stage {{ i + 1 }}</h4>
                <button
                  type="button"
                  class="btn-remove-etape"
                  (click)="removeEtape(i)"
                  *ngIf="newPipeline.etapes.length > 1"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
              <div class="etape-fields">
                <div class="form-row">
                  <div class="form-col">
                    <label [for]="'etapeName' + i">Stage Name *</label>
                    <input
                      type="text"
                      [id]="'etapeName' + i"
                      class="form-control"
                      [(ngModel)]="etape.nom"
                      [name]="'etapeName' + i"
                      placeholder="Stage name"
                      required
                      #etapeName="ngModel"
                    >
                    <div *ngIf="etapeName.invalid && etapeName.touched" class="text-danger">
                      Stage name is required.
                    </div>
                  </div>
                  <div class="form-col">
                    <label [for]="'etapeDeadline' + i">Deadline *</label>
                    <input
                      type="date"
                      [id]="'etapeDeadline' + i"
                      class="form-control"
                      [(ngModel)]="etape.deadline"
                      [name]="'etapeDeadline' + i"
                      required
                      #etapeDeadline="ngModel"
                    >
                    <div *ngIf="etapeDeadline.invalid && etapeDeadline.touched" class="text-danger">
                      Deadline is required.
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-col-full">
                    <label [for]="'etapeConsigne' + i">Description</label>
                    <textarea
                      [id]="'etapeConsigne' + i"
                      class="form-control"
                      [(ngModel)]="etape.consigne"
                      [name]="'etapeConsigne' + i"
                      placeholder="Stage description"
                      rows="2"
                    ></textarea>
                  </div>
                </div>
              </div>
            </div>
            <button type="button" class="btn-add-etape" (click)="addEtapeToPipeline()">
              <i class="fas fa-plus"></i> Add Stage
            </button>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closePipelineModal()">
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="!pipelineForm.valid || isLoading"
          >
            <i class="fas fa-save" *ngIf="!isLoading"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
            {{ isLoading ? 'Creating...' : 'Create Pipeline' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Member Modal -->
<div class="modal-overlay" *ngIf="showAddMemberModal" (click)="closeAddMemberModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="fas fa-user-plus"></i> Add New Member
      </h2>
      <button class="modal-close" (click)="closeAddMemberModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form (ngSubmit)="addMemberToGroup()" #addMemberForm="ngForm">
        <div class="form-group">
          <label for="memberEmail">Email *</label>
          <input
            type="email"
            id="memberEmail"
            class="form-control"
            [(ngModel)]="newMember.email"
            name="memberEmail"
            placeholder="Enter member email"
            required
            #memberEmail="ngModel"
          >
          <div *ngIf="memberEmail.invalid && memberEmail.touched" class="text-danger">
            Valid email is required.
          </div>
        </div>
        <div class="form-group">
          <label for="memberGitRole">Git Role *</label>
          <select
            id="memberGitRole"
            class="form-control"
            [(ngModel)]="newMember.gitRole"
            name="memberGitRole"
            required
            #memberGitRole="ngModel"
          >
            <option value="">Select Git Role</option>
            <option value="DEVELOPER">Developer</option>
            <option value="MAINTAINER">Maintainer</option>
            <option value="GUEST">Guest</option>
          </select>
          <div *ngIf="memberGitRole.invalid && memberGitRole.touched" class="text-danger">
            Git role is required.
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeAddMemberModal()">
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="!addMemberForm.valid || isLoading"
          >
            <i class="fas fa-save" *ngIf="!isLoading"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
            {{ isLoading ? 'Adding...' : 'Add Member' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>